{"version":3,"file":"TokenRatesController.js","sourceRoot":"","sources":["../../src/assets/TokenRatesController.ts"],"names":[],"mappings":"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","sourcesContent":["import { toChecksumAddress } from 'ethereumjs-util';\nimport BaseController, { BaseConfig, BaseState } from '../BaseController';\nimport { safelyExecute, handleFetch } from '../util';\n\nimport type { AssetsState } from './AssetsController';\nimport type { CurrencyRateState } from './CurrencyRateController';\n\n/**\n * @type CoinGeckoResponse\n *\n * CoinGecko API response representation\n *\n */\nexport interface CoinGeckoResponse {\n  [address: string]: {\n    [currency: string]: number;\n  };\n}\n\n/**\n * @type Token\n *\n * Token representation\n *\n * @property address - Hex address of the token contract\n * @property decimals - Number of decimals the token uses\n * @property symbol - Symbol of the token\n * @property image - Image of the token, url or bit32 image\n */\nexport interface Token {\n  address: string;\n  decimals: number;\n  symbol: string;\n  image?: string;\n  balanceError?: Error | null;\n}\n\n/**\n * @type TokenRatesConfig\n *\n * Token rates controller configuration\n *\n * @property interval - Polling interval used to fetch new token rates\n * @property tokens - List of tokens to track exchange rates for\n */\nexport interface TokenRatesConfig extends BaseConfig {\n  interval: number;\n  nativeCurrency: string;\n  tokens: Token[];\n}\n\n/**\n * @type TokenRatesState\n *\n * Token rates controller state\n *\n * @property contractExchangeRates - Hash of token contract addresses to exchange rates\n */\nexport interface TokenRatesState extends BaseState {\n  contractExchangeRates: { [address: string]: number };\n}\n\n/**\n * Controller that passively polls on a set interval for token-to-fiat exchange rates\n * for tokens stored in the AssetsController\n */\nexport class TokenRatesController extends BaseController<\n  TokenRatesConfig,\n  TokenRatesState\n> {\n  private handle?: NodeJS.Timer;\n\n  private tokenList: Token[] = [];\n\n  private getPricingURL(query: string) {\n    return `https://api.coingecko.com/api/v3/simple/token_price/ethereum?${query}`;\n  }\n\n  /**\n   * Name of this controller used during composition\n   */\n  name = 'TokenRatesController';\n\n  /**\n   * Creates a TokenRatesController instance\n   *\n   * @param options\n   * @param options.onAssetsStateChange - Allows subscribing to assets controller state changes\n   * @param options.onCurrencyRateStateChange - Allows subscribing to currency rate controller state changes\n   * @param config - Initial options used to configure this controller\n   * @param state - Initial state to set on this controller\n   */\n  constructor(\n    {\n      onAssetsStateChange,\n      onCurrencyRateStateChange,\n    }: {\n      onAssetsStateChange: (\n        listener: (assetState: AssetsState) => void,\n      ) => void;\n      onCurrencyRateStateChange: (\n        listener: (currencyRateState: CurrencyRateState) => void,\n      ) => void;\n    },\n    config?: Partial<TokenRatesConfig>,\n    state?: Partial<TokenRatesState>,\n  ) {\n    super(config, state);\n    this.defaultConfig = {\n      disabled: true,\n      interval: 180000,\n      nativeCurrency: 'eth',\n      tokens: [],\n    };\n    this.defaultState = { contractExchangeRates: {} };\n    this.initialize();\n    this.configure({ disabled: false }, false, false);\n    onAssetsStateChange((assetsState) => {\n      this.configure({ tokens: assetsState.tokens });\n    });\n    onCurrencyRateStateChange((currencyRateState) => {\n      this.configure({ nativeCurrency: currencyRateState.nativeCurrency });\n    });\n    this.poll();\n  }\n\n  /**\n   * Sets a new polling interval\n   *\n   * @param interval - Polling interval used to fetch new token rates\n   */\n  async poll(interval?: number): Promise<void> {\n    interval && this.configure({ interval }, false, false);\n    this.handle && clearTimeout(this.handle);\n    await safelyExecute(() => this.updateExchangeRates());\n    this.handle = setTimeout(() => {\n      this.poll(this.config.interval);\n    }, this.config.interval);\n  }\n\n  /**\n   * Sets a new token list to track prices\n   *\n   * TODO: Replace this wth a method\n   *\n   * @param tokens - List of tokens to track exchange rates for\n   */\n  set tokens(tokens: Token[]) {\n    this.tokenList = tokens;\n    !this.disabled && safelyExecute(() => this.updateExchangeRates());\n  }\n\n  get tokens() {\n    throw new Error('Property only used for setting');\n  }\n\n  /**\n   * Fetches a pairs of token address and native currency\n   *\n   * @param query - Query according to tokens in tokenList and native currency\n   * @returns - Promise resolving to exchange rates for given pairs\n   */\n  async fetchExchangeRate(query: string): Promise<CoinGeckoResponse> {\n    return handleFetch(this.getPricingURL(query));\n  }\n\n  /**\n   * Updates exchange rates for all tokens\n   *\n   * @returns Promise resolving when this operation completes\n   */\n  async updateExchangeRates() {\n    if (this.tokenList.length === 0) {\n      return;\n    }\n    const newContractExchangeRates: { [address: string]: number } = {};\n    const { nativeCurrency } = this.config;\n    const pairs = this.tokenList.map((token) => token.address).join(',');\n    const query = `contract_addresses=${pairs}&vs_currencies=${nativeCurrency.toLowerCase()}`;\n    const prices = await this.fetchExchangeRate(query);\n    this.tokenList.forEach((token) => {\n      const address = toChecksumAddress(token.address);\n      const price = prices[token.address.toLowerCase()];\n      newContractExchangeRates[address] = price\n        ? price[nativeCurrency.toLowerCase()]\n        : 0;\n    });\n    this.update({ contractExchangeRates: newContractExchangeRates });\n  }\n}\n\nexport default TokenRatesController;\n"]}