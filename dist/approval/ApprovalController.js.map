{"version":3,"file":"ApprovalController.js","sourceRoot":"","sources":["../../src/approval/ApprovalController.ts"],"names":[],"mappings":"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","sourcesContent":["import { nanoid } from 'nanoid';\nimport { ethErrors } from 'eth-rpc-errors';\nimport BaseController, { BaseConfig, BaseState } from '../BaseController';\n\nconst APPROVALS_STORE_KEY = 'pendingApprovals';\nconst APPROVAL_COUNT_STORE_KEY = 'pendingApprovalCount';\n\ntype ApprovalPromiseResolve = (value?: unknown) => void;\ntype ApprovalPromiseReject = (error?: Error) => void;\n\ntype RequestData = Record<string, unknown>;\n\ninterface ApprovalCallbacks {\n  resolve: ApprovalPromiseResolve;\n  reject: ApprovalPromiseReject;\n}\n\nexport interface Approval {\n  /**\n   * The ID of the approval request.\n   */\n  id: string;\n\n  /**\n   * The origin of the approval request.\n   */\n  origin: string;\n\n  /**\n   * The time that the request was received, per Date.now().\n   */\n  time: number;\n\n  /**\n   * The type of the approval request.\n   */\n  type: string;\n\n  /**\n   * Additional data associated with the request.\n   */\n  requestData?: RequestData;\n}\n\nexport interface ApprovalConfig extends BaseConfig {\n  showApprovalRequest: () => void;\n}\n\nexport interface ApprovalState extends BaseState {\n  [APPROVALS_STORE_KEY]: { [approvalId: string]: Approval };\n  [APPROVAL_COUNT_STORE_KEY]: number;\n}\n\nconst getAlreadyPendingMessage = (origin: string, type: string) =>\n  `Request of type '${type}' already pending for origin ${origin}. Please wait.`;\n\nconst defaultState: ApprovalState = {\n  [APPROVALS_STORE_KEY]: {},\n  [APPROVAL_COUNT_STORE_KEY]: 0,\n};\n\n/**\n * Controller for managing requests that require user approval.\n *\n * Enables limiting the number of pending requests by origin and type, counting\n * pending requests, and more.\n *\n * Adding a request returns a promise that resolves or rejects when the request\n * is approved or denied, respectively.\n */\nexport class ApprovalController extends BaseController<\n  ApprovalConfig,\n  ApprovalState\n> {\n  private _approvals: Map<string, ApprovalCallbacks>;\n\n  private _origins: Map<string, Set<string>>;\n\n  private _showApprovalRequest: () => void;\n\n  /**\n   * @param opts - Options bag\n   * @param opts.showApprovalRequest - Function for opening the UI such that\n   * the request can be displayed to the user.\n   */\n  constructor(config: ApprovalConfig, state?: ApprovalState) {\n    const { showApprovalRequest } = config;\n    if (typeof showApprovalRequest !== 'function') {\n      throw new Error('Must specify function showApprovalRequest.');\n    }\n\n    super(config, state || defaultState);\n\n    this._approvals = new Map();\n    this._origins = new Map();\n    this._showApprovalRequest = showApprovalRequest;\n    this.initialize();\n  }\n\n  /**\n   * Adds an approval request per the given arguments, calls the show approval\n   * request function, and returns the associated approval promise.\n   *\n   * There can only be one approval per origin and type. An error is thrown if\n   * attempting to add an invalid or duplicate request.\n   *\n   * @param opts - Options bag.\n   * @param opts.id - The id of the approval request. A random id will be\n   * generated if none is provided.\n   * @param opts.origin - The origin of the approval request.\n   * @param opts.type - The type associated with the approval request.\n   * @param opts.requestData - Additional data associated with the request,\n   * if any.\n   * @returns The approval promise.\n   */\n  addAndShowApprovalRequest(opts: {\n    id?: string;\n    origin: string;\n    type: string;\n    requestData?: RequestData;\n  }): Promise<unknown> {\n    const promise = this._add(\n      opts.origin,\n      opts.type,\n      opts.id,\n      opts.requestData,\n    );\n    this._showApprovalRequest();\n    return promise;\n  }\n\n  /**\n   * Adds an approval request per the given arguments and returns the approval\n   * promise.\n   *\n   * There can only be one approval per origin and type. An error is thrown if\n   * attempting to add an invalid or duplicate request.\n   *\n   * @param opts - Options bag.\n   * @param opts.id - The id of the approval request. A random id will be\n   * generated if none is provided.\n   * @param opts.origin - The origin of the approval request.\n   * @param opts.type - The type associated with the approval request.\n   * @param opts.requestData - Additional data associated with the request,\n   * if any.\n   * @returns The approval promise.\n   */\n  add(opts: {\n    id?: string;\n    origin: string;\n    type: string;\n    requestData?: RequestData;\n  }): Promise<unknown> {\n    return this._add(opts.origin, opts.type, opts.id, opts.requestData);\n  }\n\n  /**\n   * Gets the info for the approval request with the given id.\n   *\n   * @param id - The id of the approval request.\n   * @returns The approval request data associated with the id.\n   */\n  get(id: string): Approval | undefined {\n    const info = this.state[APPROVALS_STORE_KEY][id];\n    return info ? { ...info } : undefined;\n  }\n\n  /**\n   * Gets the number of pending approvals, by origin and/or type.\n   *\n   * If only `origin` is specified, all approvals for that origin will be\n   * counted, regardless of type.\n   * If only `type` is specified, all approvals for that type will be counted,\n   * regardless of origin.\n   * If both `origin` and `type` are specified, 0 or 1 will be returned.\n   *\n   * @param opts.origin - An approval origin.\n   * @param opts.type - The type of the approval request.\n   * @returns The current approval request count for the given origin and/or\n   * type.\n   */\n  getApprovalCount(opts: { origin?: string; type?: string } = {}): number {\n    if (!opts.origin && !opts.type) {\n      throw new Error('Must specify origin, type, or both.');\n    }\n    const { origin, type: _type } = opts;\n\n    if (origin && _type) {\n      return Number(Boolean(this._origins.get(origin)?.has(_type)));\n    }\n\n    if (origin) {\n      return this._origins.get(origin)?.size || 0;\n    }\n\n    // Only \"type\" was specified\n    let count = 0;\n    for (const approval of Object.values(this.state[APPROVALS_STORE_KEY])) {\n      if (approval.type === _type) {\n        count += 1;\n      }\n    }\n    return count;\n  }\n\n  /**\n   * @returns The current total approval request count, for all types and\n   * origins.\n   */\n  getTotalApprovalCount(): number {\n    return this.state[APPROVAL_COUNT_STORE_KEY];\n  }\n\n  /**\n   * Checks if there's a pending approval request per the given parameters.\n   * At least one parameter must be specified. An error will be thrown if the\n   * parameters are invalid.\n   *\n   * If `id` is specified, all other parameters will be ignored.\n   * If `id` is not specified, the method will check for requests that match\n   * all of the specified parameters.\n   *\n   * @param opts - Options bag.\n   * @param opts.id - The ID to check for.\n   * @param opts.origin - The origin to check for.\n   * @param opts.type - The type to check for.\n   * @returns `true` if a matching approval is found, and `false` otherwise.\n   */\n  has(opts: { id?: string; origin?: string; type?: string } = {}): boolean {\n    const { id, origin, type: _type } = opts;\n\n    if (id) {\n      if (typeof id !== 'string') {\n        throw new Error('May not specify non-string id.');\n      }\n      return this._approvals.has(id);\n    }\n\n    if (origin) {\n      if (typeof origin !== 'string') {\n        throw new Error('May not specify non-string origin.');\n      }\n\n      // Check origin and type pair if type also specified\n      if (_type && typeof _type === 'string') {\n        return Boolean(this._origins.get(origin)?.has(_type));\n      }\n      return this._origins.has(origin);\n    }\n\n    if (_type) {\n      if (typeof _type !== 'string') {\n        throw new Error('May not specify non-string type.');\n      }\n\n      for (const approval of Object.values(this.state[APPROVALS_STORE_KEY])) {\n        if (approval.type === _type) {\n          return true;\n        }\n      }\n      return false;\n    }\n    throw new Error('Must specify non-empty string id, origin, or type.');\n  }\n\n  /**\n   * Resolves the promise of the approval with the given id, and deletes the\n   * approval. Throws an error if no such approval exists.\n   *\n   * @param id - The id of the approval request.\n   * @param value - The value to resolve the approval promise with.\n   */\n  resolve(id: string, value?: unknown): void {\n    this._deleteApprovalAndGetCallbacks(id).resolve(value);\n  }\n\n  /**\n   * Rejects the promise of the approval with the given id, and deletes the\n   * approval. Throws an error if no such approval exists.\n   *\n   * @param id - The id of the approval request.\n   * @param error - The error to reject the approval promise with.\n   */\n  reject(id: string, error: Error): void {\n    this._deleteApprovalAndGetCallbacks(id).reject(error);\n  }\n\n  /**\n   * Rejects and deletes all approval requests.\n   */\n  clear(): void {\n    const rejectionError = ethErrors.rpc.resourceUnavailable(\n      'The request was rejected; please try again.',\n    );\n\n    for (const id of this._approvals.keys()) {\n      this.reject(id, rejectionError);\n    }\n    this._origins.clear();\n    this.update(defaultState, true);\n  }\n\n  /**\n   * Implementation of add operation.\n   *\n   * @param origin - The origin of the approval request.\n   * @param type - The type associated with the approval request.\n   * @param id - The id of the approval request.\n   * @param requestData - The request data associated with the approval request.\n   * @returns The approval promise.\n   */\n  private _add(\n    origin: string,\n    type: string,\n    id: string = nanoid(),\n    requestData?: RequestData,\n  ): Promise<unknown> {\n    this._validateAddParams(id, origin, type, requestData);\n\n    if (this._origins.get(origin)?.has(type)) {\n      throw ethErrors.rpc.resourceUnavailable(\n        getAlreadyPendingMessage(origin, type),\n      );\n    }\n\n    // add pending approval\n    return new Promise((resolve, reject) => {\n      this._approvals.set(id, { resolve, reject });\n      this._addPendingApprovalOrigin(origin, type);\n      this._addToStore(id, origin, type, requestData);\n    });\n  }\n\n  /**\n   * Validates parameters to the add method.\n   *\n   * @param id - The id of the approval request.\n   * @param origin - The origin of the approval request.\n   * @param type - The type associated with the approval request.\n   * @param requestData - The request data associated with the approval request.\n   */\n  private _validateAddParams(\n    id: string,\n    origin: string,\n    type: string,\n    requestData?: RequestData,\n  ): void {\n    let errorMessage = null;\n    if (!id || typeof id !== 'string') {\n      errorMessage = 'Must specify non-empty string id.';\n    } else if (this._approvals.has(id)) {\n      errorMessage = `Approval with id '${id}' already exists.`;\n    } else if (!origin || typeof origin !== 'string') {\n      errorMessage = 'Must specify non-empty string origin.';\n    } else if (!type || typeof type !== 'string') {\n      errorMessage = 'Must specify non-empty string type.';\n    } else if (\n      requestData &&\n      (typeof requestData !== 'object' || Array.isArray(requestData))\n    ) {\n      errorMessage = 'Request data must be a plain object if specified.';\n    }\n\n    if (errorMessage) {\n      throw ethErrors.rpc.internal(errorMessage);\n    }\n  }\n\n  /**\n   * Adds an entry to _origins.\n   * Performs no validation.\n   *\n   * @param origin - The origin of the approval request.\n   * @param type - The type associated with the approval request.\n   */\n  private _addPendingApprovalOrigin(origin: string, type: string): void {\n    const originSet = this._origins.get(origin) || new Set();\n    originSet.add(type);\n\n    if (!this._origins.has(origin)) {\n      this._origins.set(origin, originSet);\n    }\n  }\n\n  /**\n   * Adds an entry to the store.\n   * Performs no validation.\n   *\n   * @param id - The id of the approval request.\n   * @param origin - The origin of the approval request.\n   * @param type - The type associated with the approval request.\n   * @param requestData - The request data associated with the approval request.\n   */\n  private _addToStore(\n    id: string,\n    origin: string,\n    type: string,\n    requestData?: RequestData,\n  ): void {\n    const approval: Approval = { id, origin, type, time: Date.now() };\n    if (requestData) {\n      approval.requestData = requestData;\n    }\n\n    const approvals = {\n      ...this.state[APPROVALS_STORE_KEY],\n      [id]: approval,\n    };\n\n    this.update(\n      {\n        [APPROVALS_STORE_KEY]: approvals,\n        [APPROVAL_COUNT_STORE_KEY]: Object.keys(approvals).length,\n      },\n      true,\n    );\n  }\n\n  /**\n   * Deletes the approval with the given id. The approval promise must be\n   * resolved or reject before this method is called.\n   * Deletion is an internal operation because approval state is solely\n   * managed by this controller.\n   *\n   * @param id - The id of the approval request to be deleted.\n   */\n  private _delete(id: string): void {\n    this._approvals.delete(id);\n\n    const approvals = this.state[APPROVALS_STORE_KEY];\n    const { origin, type } = approvals[id];\n\n    (this._origins.get(origin) as Set<string>).delete(type);\n    if (this._isEmptyOrigin(origin)) {\n      this._origins.delete(origin);\n    }\n\n    const newApprovals = { ...approvals };\n    delete newApprovals[id];\n    this.update(\n      {\n        [APPROVALS_STORE_KEY]: newApprovals,\n        [APPROVAL_COUNT_STORE_KEY]: Object.keys(newApprovals).length,\n      },\n      true,\n    );\n  }\n\n  /**\n   * Gets the approval callbacks for the given id, deletes the entry, and then\n   * returns the callbacks for promise resolution.\n   * Throws an error if no approval is found for the given id.\n   *\n   * @param id - The id of the approval request.\n   * @returns The promise callbacks associated with the approval request.\n   */\n  private _deleteApprovalAndGetCallbacks(id: string): ApprovalCallbacks {\n    const callbacks = this._approvals.get(id);\n    if (!callbacks) {\n      throw new Error(`Approval with id '${id}' not found.`);\n    }\n\n    this._delete(id);\n    return callbacks;\n  }\n\n  /**\n   * Checks whether there are any approvals associated with the given\n   * origin.\n   *\n   * @param origin - The origin to check.\n   * @returns True if the origin has no approvals, false otherwise.\n   */\n  private _isEmptyOrigin(origin: string): boolean {\n    return !this._origins.get(origin)?.size;\n  }\n}\nexport default ApprovalController;\n"]}